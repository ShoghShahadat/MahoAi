// Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø®
document.getElementById('dataForm').addEventListener('submit', async function(event) {
  event.preventDefault();
  const text = document.getElementById('textInput').value;
  const outputDiv = document.getElementById('output');

  outputDiv.innerHTML = '<p style="color: #b0b0b0;">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</p>';

  try {
    const response = await fetch('http://127.0.0.1:8283/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });

    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();

    outputDiv.innerHTML = formatJsonToItems(data);
    document.getElementById('applyChangesBtn').style.display = 'block';
    attachApplyChangesListener();
  } catch (error) {
    console.error('Error:', error);
    outputDiv.innerHTML = `<p style="color: #ff6f61;">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: ${error.message}</p>`;
  }
});

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ JSON Ø¨Ù‡ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
function formatJsonToItems(data) {
  let html = '';

  if (data.message) {
    html += `
      <div class="item">
        <div class="item-title">Ù¾ÛŒØ§Ù…:</div>
        <div class="item-content">${data.message}</div>
      </div>`;
  }

  if (data.pip && data.pip.trim() !== '') {
    html += `
      <div class="item">
        <div class="item-title">Ú©ØªØ§Ø¨â€ŒØ®ÙˆÙ†Ù‡â€ŒÙ‡Ø§:</div>
        <div class="item-content">${data.pip}</div>
        <button id="install-lib-button" style="display:block; margin-top: 10px;">Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§</button>
      </div>`;
  }

  if (data.log) {
    html += `
      <div class="item">
        <div class="item-title">Ú¯Ø²Ø§Ø±Ø´:</div>
        <div class="item-content">${data.log}</div>
      </div>`;
  }

  if (data.edits && Array.isArray(data.edits)) {
    data.edits.forEach((edit, index) => {
      html += `
        <div class="item">
          <div class="item-title2" style="color: #ff8a80;">ÙˆÛŒØ±Ø§ÛŒØ´ ${index + 1}:</div>
          <div class="item-content">
            <div class="nested-item"><strong style="color: #70dbdb;">Ù…Ø³ÛŒØ±:</strong> ${edit.path || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</div>
            <div class="nested-item"><strong style="color: #70dbdb;">Ú¯Ø²Ø§Ø±Ø´:</strong> ${edit.log || 'Ø¨Ø¯ÙˆÙ† Ú¯Ø²Ø§Ø±Ø´'}</div>
            <div class="nested-item"><strong style="color: #70dbdb;">ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ${edit.info || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª'}</div>
            ${edit.edits && Array.isArray(edit.edits) ? edit.edits.map((subEdit, subIndex) => `
              <div class="nested-item">
                <strong style="color: #ff8a80;">ÙˆÛŒØ±Ø§ÛŒØ´ ${subIndex + 1}:</strong><br>
                <strong style="color: #a5d6a7;">Ø®Ø·ÙˆØ·:</strong> ${subEdit.start_number_line || 'ØŸ'} <strong style="color: #a5d6a7;">ØªØ§</strong> ${subEdit.end_number_line || 'ØŸ'}<br>
                <strong style="color: #a5d6a7;">Ù†ÙˆØ¹:</strong> ${subEdit.type || 'Ù†Ø§Ù…Ø´Ø®Øµ'}<br>
                Ú©Ø¯ Ø¬Ø¯ÛŒØ¯: <pre>${subEdit.new_code || 'Ø¨Ø¯ÙˆÙ† Ú©Ø¯'}</pre>
              </div>`).join('') : ''}
          </div>
        </div>`;
    });
  }

  setTimeout(() => {
    const installButton = document.getElementById('install-lib-button');
    if (installButton) {
      installButton.addEventListener('click', async () => {
        try {
          const response = await fetch('http://127.0.0.1:8283/pip');
          const data = await response.json();
          alert(data.status === 'success' ? 'Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù†ØµØ¨ Ø´Ø¯Ù†Ø¯.' : `Ø®Ø·Ø§ Ø¯Ø± Ù†ØµØ¨ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§: ${data.error || 'Ù†Ø§Ù…Ø´Ø®Øµ'}`);
        } catch (error) {
          console.error('Error:', error);
          alert('Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡.');
        }
      });
    }
  }, 0);

  return html;
}

// Ø§ØªØµØ§Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ù‡ Ø¯Ú©Ù…Ù‡ Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª
function attachApplyChangesListener() {
  const applyChangesBtn = document.getElementById('applyChangesBtn');
  if (applyChangesBtn) {
    applyChangesBtn.removeEventListener('click', handleApplyChanges);
    applyChangesBtn.addEventListener('click', handleApplyChanges);
  }
}

async function handleApplyChanges() {
  try {
    const response = await fetch('http://127.0.0.1:8283/set_json', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(getEditsFromPage())
    });

    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();

    alert('ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯.');
    await populateBackupVersions();
    console.log('Ù¾Ø§Ø³Ø® Ø§Ø² Ø³Ø±ÙˆØ±:', data);
  } catch (error) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', error);
    alert(`Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª: ${error.message}`);
  }
}

function getEditsFromPage() {
  return { message: 'ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯.' }; // Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ù…Ù†Ø·Ù‚ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø´Ù‡
}

async function populateBackupVersions() {
  try {
    const response = await fetch('http://127.0.0.1:8283/list_versions');
    const data = await response.json();
    const versionDropdown = document.getElementById('backupVersion');
    if (versionDropdown) {
      versionDropdown.innerHTML = data.versions.map(version =>
        `<option value="${version}">Version ${version}</option>`
      ).join('');
    }
  } catch (error) {
    console.error('Error fetching backup versions:', error);
  }
}

function showRestoreDialog() {
  const version = document.getElementById('backupVersion').value;
  if (confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù†Ø³Ø®Ù‡ ${version} Ø±Ø§ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ú©Ù†ÛŒØ¯ØŸ`)) {
    restoreBackup(version);
  }
}

async function restoreBackup(version) {
  try {
    const response = await fetch(`http://127.0.0.1:8283/restore_version/${version}`, { method: 'POST' });
    const data = await response.json();
    alert(data.message || 'Ù†Ø³Ø®Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯.');
  } catch (error) {
    console.error('Error restoring version:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø³Ø®Ù‡.');
  }
}

function createBackupRestoreElements() {
  const formContainer = document.querySelector('.form-container') || document.body;

  formContainer.insertAdjacentHTML('beforeend', `
    <label for="backupVersion">Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø³Ø®Ù‡ Ø¨Ú©Ø§Ù¾:</label>
    <select id="backupVersion" name="backupVersion"></select>
    <button type="button" id="restoreBackupBtn" style="background-color: #dc3545; border-color: #dc3545; color: white;">Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ú©Ø§Ù¾</button>
  `);

  document.getElementById('restoreBackupBtn').addEventListener('click', showRestoreDialog);
  populateBackupVersions();
}

createBackupRestoreElements();

async function requestNewPathFromServer() {
  try {
    const response = await fetch('http://127.0.0.1:8283/set_path');
    const data = await response.json();
    if (data.status === 'success' && data.path) {
      displaySelectedPath(data.path);
      console.log('âœ… Ù…Ø³ÛŒØ± Ø¬Ø¯ÛŒØ¯:', data.path);
    } else {
      console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…Ø³ÛŒØ±:', data.error || data.message);
    }
  } catch (error) {
    console.error('âš ï¸ Ø®Ø·Ø§:', error);
  }
}

function displaySelectedPath(path) {
  let displayDiv = document.getElementById('selectedPathDisplay');
  if (!displayDiv) {
    displayDiv = document.createElement('div');
    displayDiv.id = 'selectedPathDisplay';
    document.body.appendChild(displayDiv);
  }
  displayDiv.innerHTML = `ğŸ“‚ <strong>Ù…Ø³ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</strong> ${path}`;
  displayDiv.style.cursor = 'pointer';
  displayDiv.onclick = requestNewPathFromServer;
}

async function checkAndSelectPath() {
  try {
    const response = await fetch('http://127.0.0.1:8283/path');
    const data = await response.json();
    if (data.path) {
      displaySelectedPath(data.path);
    } else {
      await requestNewPathFromServer();
    }
  } catch (error) {
    console.error('âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…Ø³ÛŒØ±:', error);
  }
}

checkAndSelectPath();

// Ø§ÙØ²ÙˆØ¯Ù† Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§
const colors = ['#6d1e78', '#155950', '#9370db', '#ffffff', '#add8e6'];
for (let i = 0; i < 200; i++) {
  const star = document.createElement('div');
  star.classList.add('star');
  Object.assign(star.style, {
    left: `${Math.random() * 100}vw`,
    top: `${Math.random() * 100}vh`,
    animationDelay: `${Math.random() * 2}s`,
    backgroundColor: colors[Math.floor(Math.random() * colors.length)]
  });
  document.body.appendChild(star);
}