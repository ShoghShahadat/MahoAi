import json
import re
from flask import Flask, request, jsonify
import requests

app = Flask(__name__)

GEMINI_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=AIzaSyBtFUS6aAbg0yrP26EUUpq3e-LOEnE8nbc"


def fix_and_parse_json(response_data):
    """
    این تابع ورودی که ممکن است شامل توضیحات اضافی و بلوک‌های markdown باشد را بررسی کرده و بلوک JSON را استخراج می‌کند.
    اگر ورودی از قبل دیکشنری باشد، مستقیماً برمی‌گرداند.
    """
    if isinstance(response_data, dict):
        return response_data

    # تلاش برای استخراج بلوک JSON بین ```json و ```
    pattern = re.compile(r"```json(.*?)```", re.DOTALL)
    match = pattern.search(response_data)
    if match:
        json_text = match.group(1).strip()
    else:
        # اگر بلوک json یافت نشد، سعی می‌کنیم بلوک بین ``` را استخراج کنیم
        pattern2 = re.compile(r"```(.*?)```", re.DOTALL)
        match2 = pattern2.search(response_data)
        if match2:
            json_text = match2.group(1).strip()
        else:
            # در نهایت، کل متن پاکسازی شده را در نظر می‌گیریم
            json_text = response_data.strip()

    # حذف کاماهای اضافی قبل از } یا ]
    json_text = re.sub(r',\s*([\}\]])', r'\1', json_text)

    if not json_text:
        raise ValueError("متن پاکسازی شده خالی است.")

    try:
        return json.loads(json_text)
    except json.JSONDecodeError as e:
        raise ValueError(f"خطا در تبدیل رشته به JSON: {e}")


@app.route('/generate', methods=['POST'])
def handle_request():
    # دریافت متن از کاربر
    user_text = request.json.get('text')

    if not user_text:
        return jsonify({'error': 'متن ورودی یافت نشد'}), 400


    base_json =  jsonify({'text': user_text})
    text_output = json.dumps(base_json.json)
    qavanin = """
       ممنوعیت ها:
    [
       تصاویر برهنگی
       پورنوگرافی
           شخصیت های سیاسی و روحانی ایرانی
           شخصیت آقای خامنه ای
           شخصیت آقای خمینی
           شخصیت های بازیگر ایرانی
           ]
                   """

    base_json2 = """
        {
            "review":0,
           "Suggestions": [],
           "nudity" : false,
           "Advertising" : false,
           "caption": ""
       }
       """
    # noinspection SpellCheckingInspection
    PR = f""" جیسون زیر را کامل کن:
                   {base_json2}
                        دستور چجوری پیشنهاد دادن به کاربر :
                                                      می‌تونی تا جای ممکن به نسبت پرامت شرایط محیط تصویر خواسته شده توصیف کنی و خودت رو در شرایط پرامت بزاری و کامل توصیف کنی با تمامی تکنیک های طراحی
                                                      میتونی پرامت رو زیبا سازی کنی و از انواع شرایط برای زیباتر شدن بهره بگیری
                                                      میتونی متناسب با موضوع پرامت فضا سازی حرفه ای انجام بدی
                                                      میتونی متناسب با موضوع پرامت بافت توصیف کنی و به توصیف جزئیات بسیار دقت کنی
                                                      میتونی حالت نگاه سوژه و کاراکتر ها و زاویه دوربین رو توی بهترین حالت توصیف کنی
                                                      میتونی پرامت برای پرامت شرایط نور پردازی حرفه ای توصیف کنی
                                                      میتونی برای پرامتن ژست ها و حالات برای القای حس واقعی پرامت توصیف کنی
                                                      میتونی از زاویه های متفاوت به پرامت نگاه کنی
                                                      میتونی فوکوس پرامت رو روی سوژه اصلی بزاری
                                                      میتونی بهترین رنگ بندی برای اجزای پرامت انتخاب کنی
                                                      میتونی از رنگ های مکمل حرفه ای استفاده کنی
                                                      میتونی بهترین مکان هارو برای پرامت بازگو کنی
                   نکته: اگه درون  موارد تبلیغاتی مانند لینک یا آیدی یا درخواست لوگو برای اسم چنلی بود مقدار Advertising را true  بده
                    نکته: با توجه به text که درخواست کاربر برای ساخت یک عکس است تمامی عناوین مرتبط به text کاربر رو توی prompts به صورت آرایه پیشنهاد بده
                    برای مثال اگه text برابر ایران بود باید برای Suggestions صنایع دستی و سوغاتی و قومیت ها و مکان های گردشگری و هر چیزی که بتوان با آن یک عکس زیبا و مرتبط خلق کرد پیشنهاد دهی
                   نکته: پیشنهادات باید بسیار دقیق و خلاقانه باشد مانند گربه پرشین و انار و زعفران و لباس محلی برای ایران
                   نکته: پیشنهادات باید بیشترین نزدیکی به واقعیت فعلی داشته باشد مانند جنگ و کودکان مظلوم و بیگناه و کبوتران درحال پرواز و خرابه ها برای غزه
                   نکته: پیشنهادات باید احساسات کامل منتقل کند مثلا ظلم و جنایت و خون ریزی و آدم کشی برای اسرائیل
                   نکته: باید عناوینی که با text بیشتر شناخته شدن بیشتر در نظر بگیری مانند شیر و زرافه برای آفریقا
                   نکته: باید آدمای فاسد رو تا جای ممکن بد جلوه بدی مانند خون ریزی برای text هایی مانند نتانیاهو و ترامپ
                   نکته: پبشنهادات باید تا جای ممکن شبیه به text باشه و درخواست کاربر رو کاملا نشون بده بدون کم و کاستی
                   نکته: باید تمامی صحنه هایی که میتوان خلق کرد در نظر بگیری مانند بازی یک سگ در دشت برای سگ یا بچه فیلی در حالی که با خرطوم خود دم مادر را گرفته برای فیل و بتوانی برای هر عبارت دارای معنی یک صحنه زیبا و تاثیر گذار پیشنهاد دهی
                    نکته: باید از پیشنهاد های صریح و شفاف استفاده کنی مانند یک شیر در طبیعت وحشی و تمام جزئیات عکسی که میتوان تولید کرد شرح دهی
                    نکته: استفاده از سبک های نقاشی و رنگ و روغن و 2 بعدی ممنوع است و باید سبک های فانتزی واقعی واقع گرایانه و 3 بعدی و ترکیب این ها استفاده کنی برای زیبایی

                                                  دستور مستقیم:
                                                                   اگه متن text  شامل ممنوعیت ها بود کارای زیر رو انجام بده:
                                نکته خیلی مهم: فقط و فقط مقدار text از جیسون شماره 1اولیه نیاز به برسی دارد 
                                 دستور : محتوای Suggestions مصون از برسی شدن هستن
                               اگه متن text شامل ممنوعیت ها بود مقدار nudity رو برابر true قرار بده
                                2- مقدار Suggestions باید برابر '[]' یعنی یک لیست خالی باشه حتما
                               3- به کاربر توی caption بگو پرامتش شامل چه ممنوعیت هایی هست و بهش هشدار بده دیگه تکرار نکنه وگرنه از ربات مسدود و از کانال حذف میشه
                              4- مقدار review رو بگو با چه حساسیتی این ممنوعیت شناسایی شده مثلا اگه واضح کاربر اشاره مستقیم کرده باشه مقدارش باید 100 باشه و اگه هیج ممنوعیتی وجود نداشته باشه مقدارش 0 و سایر موارد باید به درصد بگی
                               پرامت کاربر رو اصلاح موارد ممنوعش حذف و به کاربر پیشنهاد بده و تشویقش کن این پرامت بفرسته
                               به کاربر باید بگی دقیقا کجای پرامتش ایراد داره و چجوری ایرادش برطرف کنه تا تصویر ساخته بشه
                               چند پرامت بدون ایراد از پرامت کاربر بساز و بگو
                              با لحن تمسخر آمیز و دوستانه با کاربر حرف بزن و مثلا با بازی به کاربر بگو صب کن الا عکس هارو میفرستم ، بعد چند خط پایین تر بگو شوخی کردم عامو این پرامتت این مشکلات داره
                              شوخی هات مانند بازی و دست انداختن و تلاش کاربر برای دور زدن سیستم رو به سخره بگیره و وانمود کنی داری گول میخوری
                              به کاربر بگی چرا نباید اینجور محتوا ها بخوایم و اشکالش چیه
                                                  """


    payload = {
        "contents": [
            {
                "role": "user",
                "parts": [
                    {
                        "text": "Make the outputs in JSON format."
                    } ,
                    {
                        "text": qavanin
                    },
                    {
                        "text": PR
                    }
                ]
            },
            {"role": "user",
            "parts": [{"text": text_output}]
        }]
    }
    print(payload)

    try:
        # ارسال درخواست به API گوگل
        response = requests.post(GEMINI_ENDPOINT, json=payload)
        print(response.text)
        response.raise_for_status()

        # پردازش پاسخ
        gemini_response = response.json()
        generated_text = gemini_response['candidates'][0]['content']['parts'][0]['text']

        # استفاده از تابع fix_and_parse_json برای پاکسازی و تبدیل متن به دیکشنری
        generated_js = fix_and_parse_json(generated_text)

        # ارسال به فرمت JSON
        return jsonify(generated_js)

    except Exception as e:
        return jsonify({'error': str(e)}), 500


if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=8283)
